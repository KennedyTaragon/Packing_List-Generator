{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-6 mx-auto">
        <!-- Upload Section -->
        <div class="card">
            <div class="card-body p-5">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-cloud-upload text-primary"></i>
                    Generate Packing List
                </h2>
                
                <form method="post" enctype="multipart/form-data" id="uploadForm" action="{% url 'process_dat' %}">
                    {% csrf_token %}
                    
                    <div class="upload-area mb-4" id="uploadArea">
                        <i class="bi bi-file-earmark-arrow-up" style="font-size: 4rem; color: #6c757d;"></i>
                        <h5 class="mt-3">Drag & Drop your DAT file here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" name="dat_file" id="datFileInput" accept=".dat" required style="display: none;">
                        <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('datFileInput').click()">
                            <i class="bi bi-folder2-open"></i> Browse Files
                        </button>
                        <p class="text-muted mt-3 mb-0" id="selectedFile"></p>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="bi bi-gear-fill"></i> Generate Packing List
                        </button>
                    </div>
                </form>
                
                <div class="alert alert-info mt-4 mb-0" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Supported Format:</strong> .dat files only (Max 10MB)
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-question-circle"></i> How It Works
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Upload your KCB DAT file using the form above</li>
                    <li class="mb-2">The system will parse the file and extract order data</li>
                    <li class="mb-2">A packing list PDF will be generated</li>
                    <li class="mb-2">Download the PDF automatically when ready</li>
                    <li class="mb-2">PRESS F5 ON HAPO KWA KEYBORD NDO U-PROCESS ANOTHER ORDER</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const fileInput = document.getElementById('datFileInput');
    const uploadArea = document.getElementById('uploadArea');
    const submitBtn = document.getElementById('submitBtn');
    const uploadForm = document.getElementById('uploadForm');
    const selectedFileText = document.getElementById('selectedFile');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    // File selection handler
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            const file = this.files[0];
            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2); // KB
            
            // Validate file
            if (!fileName.endsWith('.dat')) {
                alert('Please select a .dat file');
                this.value = '';
                submitBtn.disabled = true;
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must not exceed 10MB');
                this.value = '';
                submitBtn.disabled = true;
                return;
            }
            
            selectedFileText.innerHTML = `<strong>Selected:</strong> ${fileName} (${fileSize} KB)`;
            uploadArea.style.borderColor = '#1a237e';
            submitBtn.disabled = false;
        }
    });
    
    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('dragover');
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('dragover');
        });
    });
    
    uploadArea.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            // Trigger change event
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }
    });
    
    // Click anywhere in upload area to browse
    uploadArea.addEventListener('click', function(e) {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });
    
    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a file first');
            return;
        }
        
        // Show loading spinner
        loadingSpinner.classList.add('active');
        submitBtn.disabled = true;
    });
    
    // Handle errors by hiding spinner
    window.addEventListener('error', function() {
        loadingSpinner.classList.remove('active');
        submitBtn.disabled = false;
    });
</script>
{% endblock %}